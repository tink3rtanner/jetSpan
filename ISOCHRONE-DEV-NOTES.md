# Flight Isochrone Map - Development Notes

## Overview

`isochrone.html` is a standalone visualization showing multimodal travel time isochrones on a 3D globe. It shows how long it takes to travel from an origin city to anywhere in the world, combining ground transport + flight + ground transport at destination.

## Tech Stack

- **MapLibre GL JS v5.0.0** - Required for globe projection (v5+ only)
- **H3-js v4.1.0** - Uber's hexagonal grid system
- **OpenFreeMap tiles** - Free, no API key needed (`https://tiles.openfreemap.org/styles/positron`)
- **Vanilla JS** - No build step, matches existing codebase pattern

## Key Features

1. **Globe projection** - 3D rotating globe view
2. **H3 hexagonal grid** - Colored by travel time bands
3. **6 origin cities** - Bristol, London, New York, Paris, Tokyo, Sydney
4. **81 airports** with ~349 flight routes
5. **Interactive tooltips** showing routing breakdown
6. **Toggle controls** for airports and hex grid visibility

## Data Sources (Currently Hardcoded)

### Airports (`AIRPORTS` array)
- ~81 major world airports with coordinates
- Manually curated, not comprehensive
- Format: `{ code, name, coordinates: [lng, lat], country }`

### Flight Times (`FLIGHT_TIMES` object)
- ~349 routes between major airports
- Times in minutes
- NOT comprehensive - many routes missing
- Format: `'ORIGIN': { 'DEST': minutes, ... }`

### Origins (`ORIGINS` object)
- 6 pre-configured origin cities
- Each has: `name`, `coordinates`, `nearestAirport`, `alternativeAirports`
- Alternative airports allow routing via major hubs (e.g., Bristol can route via LHR)

## Travel Time Calculation

```
Total = groundToAirport + airportOverhead(90min) + flight + arrivalOverhead(30-60min) + groundFromAirport
```

- **Ground time**: Haversine distance / 40 km/h
- **Airport overhead**: 90 minutes (security, boarding)
- **Arrival overhead**: 30 min domestic, 60 min international
- **Flight time**: From `FLIGHT_TIMES` or estimated from great circle distance

### Algorithm
1. For each H3 cell centroid, find the 10 nearest destination airports
2. Try all combinations of origin airports (nearest + alternatives) × destination airports
3. Pick route with minimum total travel time (not just nearest airport geographically)
4. Color cell by time band

This approach ensures that ocean cells or cells far from airports still get reasonable travel times by finding the optimal destination airport, even if it requires more ground travel from a major hub.

## Time Bands (Galton-style)

```javascript
const TIME_BANDS = [
  { maxHours: 2, color: '#22c55e', label: '< 2h' },      // Green
  { maxHours: 4, color: '#84cc16', label: '2-4h' },      // Lime
  { maxHours: 6, color: '#eab308', label: '4-6h' },      // Yellow
  { maxHours: 8, color: '#f97316', label: '6-8h' },      // Orange
  { maxHours: 10, color: '#ef4444', label: '8-10h' },    // Red
  { maxHours: 12, color: '#dc2626', label: '10-12h' },   // Dark red
  { maxHours: 14, color: '#991b1b', label: '12-14h' },   // Darker red
  { maxHours: Infinity, color: '#450a0a', label: '14h+' } // Very dark
];
```

## H3 Grid Generation

### Dynamic Resolution (Viewport-based)
Grid is now rendered only for the visible viewport, enabling finer resolution:
- **Resolution 2**: Globe view (zoom < 2), ~86k km² cells
- **Resolution 3**: Continental (zoom 2-3.5), ~12k km² cells
- **Resolution 4**: Regional (zoom 3.5-5), ~1.7k km² cells
- **Resolution 5**: Local (zoom 5-7), ~252 km² cells
- **Resolution 6**: Street level (zoom 7+), ~36 km² cells

Typical cell counts per viewport: 1,000-15,000 (vs 250k+ for full world)

### Sampling
Grid is generated by sampling lat/lng points and getting H3 cells:
```javascript
const step = resolution === 2 ? 1.5 : (resolution === 3 ? 0.7 : 0.2);
for (let lat = -55; lat <= 75; lat += step) {
  for (let lng = -180; lng <= 180; lng += step) {
    // Get H3 cell, calculate travel time, add to features
  }
}
```

**Known issue**: Step size affects coverage. Too large = gaps. Too small = slow.

### Antimeridian Handling
Cells that cross the 180° longitude line (antimeridian) have coordinates on both sides:
- Some near +180 (e.g., 170°, 175°)
- Some near -180 (e.g., -170°, -175°)

**Solution**: Normalize by shifting negative longitudes to positive:
```javascript
if (hasPositive && hasNegative) {
  coordinates = coordinates.map(([lng, lat]) => [
    lng < 0 ? lng + 360 : lng,
    lat
  ]);
}
```
This keeps polygons contiguous (e.g., 170°, 175°, 185°, 190°) instead of wrapping around the world.

## MapLibre Configuration

### Globe Projection (v5+ required)
```javascript
map.on('style.load', () => {
  map.setProjection({ type: 'globe' });
});
```

### Layer Order (bottom to top)
1. `hexgrid-fill` - Colored hex cells
2. `hexgrid-line` - Hex borders (hidden at low zoom)
3. `country-borders` - White country borders
4. `airports` - White dot markers
5. `airport-labels` - Airport codes (visible at zoom 4+)
6. `origin-pulse` - Green glow effect
7. `origin` - Green origin marker

### Hex Border Visibility (zoom-based)
```javascript
'line-width': ['interpolate', ['linear'], ['zoom'], 0, 0, 3, 0, 5, 0.3, 8, 0.5],
'line-opacity': ['interpolate', ['linear'], ['zoom'], 0, 0, 3, 0, 5, 0.1, 8, 0.15]
```

### Fill Opacity (time-based fade)
```javascript
'fill-opacity': ['interpolate', ['linear'], ['get', 'travelTimeMinutes'],
  0, 0.45,      // Near origin
  360, 0.4,     // 6 hours
  600, 0.3,     // 10 hours
  840, 0.2,     // 14 hours
  1200, 0.1     // 20+ hours (mostly ocean)
]
```

## Known Issues & Future Improvements

### Issues
1. ~~**Tooltip "Arrival + ground" too high**~~ - FIXED: Now tries top 10 nearest destination airports to find minimum total travel time
2. ~~**No dynamic resolution**~~ - FIXED: Grid regenerates on zoom/pan with viewport-based rendering
3. ~~**Antimeridian gap/artifacts**~~ - FIXED: Cells crossing 180° longitude are now normalized instead of skipped
4. **Incomplete flight data** - Many routes missing, could integrate OpenFlights database

### Future Improvements
1. ~~**Dynamic resolution on zoom**~~ - DONE: Uses res 2-6 based on zoom level
2. **Real flight data** - Integrate OpenFlights (~67k routes) or MCP for live data
3. **Hub routing** - If no direct flight, try via major hubs (LHR, FRA, DXB, etc.)
4. **Caching** - Pre-compute grids for common origins
5. **Land-only cells** - Filter out ocean cells (needs coastline data)
6. **Better ground transport** - Use actual road networks instead of haversine
7. **Web Workers** - Move grid computation to background thread for smoother UX

## Running Locally

```bash
cd /Users/joshpriebe/Documents/AI/repo/mapwarp
python -m http.server 8765
# Open http://localhost:8765/isochrone.html
```

## File Structure

```
mapwarp/
├── isochrone.html          # Main visualization (this file)
├── flight-isochrone-spec.md # Original spec document
├── index.html              # Other visualization (warped maps)
├── panels.html             # 9-panel comparison view
├── lhostis.html            # 3D shrivelled USA map
└── ISOCHRONE-DEV-NOTES.md  # This documentation
```

## Key Code Sections

- **Lines 1-250**: HTML structure, CSS styling
- **Lines 250-600**: Airport data (AIRPORTS array)
- **Lines 600-800**: Flight time data (FLIGHT_TIMES object)
- **Lines 800-950**: Travel time calculation functions
- **Lines 950-1050**: H3 grid generation
- **Lines 1050-1200**: MapLibre initialization and layers
- **Lines 1200-1300**: Event handlers and UI

## Dependencies (CDN)

```html
<script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
```

## Testing Checklist

- [x] Globe rotates smoothly
- [x] Hex colors match legend
- [x] Origin selector changes grid
- [x] Airports toggle works
- [x] Hex grid toggle works
- [x] Tooltip shows on hover
- [x] Country borders visible
- [x] No antimeridian gaps
- [x] No darker/lighter hemisphere artifacts
- [ ] No console errors
