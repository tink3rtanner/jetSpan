# Flight Isochrone Map - Development Notes

## Overview

`isochrone.html` is a standalone visualization showing multimodal travel time isochrones on a 3D globe. It shows how long it takes to travel from an origin city to anywhere in the world, combining ground transport + flight + ground transport at destination.

## Tech Stack

- **MapLibre GL JS v5.0.0** - Required for globe projection (v5+ only)
- **H3-js v4.1.0** - Uber's hexagonal grid system
- **OpenFreeMap tiles** - Free, no API key needed (`https://tiles.openfreemap.org/styles/positron`)
- **Vanilla JS** - No build step, matches existing codebase pattern

## Key Features

1. **Globe projection** - 3D rotating globe view
2. **H3 hexagonal grid** - Colored by travel time bands
3. **6 origin cities** - Bristol, London, New York, Paris, Tokyo, Sydney
4. **4518 airports**, 58k routes (loaded from `data/*.json`)
5. **Pre-computed dijkstra routing** - multi-stop connections, compact JSON
6. **Interactive tooltips** showing routing breakdown
7. **Toggle controls** for airports and hex grid visibility

## Data Sources

### Airports (`data/airports.json`)
- 4518 airports from OurAirports (large + medium)
- Format: `{ code: { name, lat, lng, country, type } }`
- Loaded at page init into `LOADED_AIRPORTS`

### Routes (`data/routes.json`)
- 58,359 routes merged from Amadeus + OpenFlights
- Format: `{ origin_code: [dest_code, ...] }`
- Flight times estimated from great-circle distance (no schedule data yet)

### Pre-computed Isochrones (`data/isochrones/{origin}.json`)
- Generated by `scripts/precompute-isochrone.py` using dijkstra routing
- Compact format: `{ t, o, a, s }` per H3 cell (time, origin airport, dest airport, stops)
- Bristol: 143,077 cells across res 1-4, 8.7 MB
- Loaded at page init, rendered directly by `generateHexGridDirect()`

### Origins (`ORIGINS` object in isochrone.html)
- 6 pre-configured origin cities
- Each has: `name`, `coordinates`, `nearestAirport`, `alternativeAirports`
- Alternative airports allow routing via major hubs (e.g., Bristol can route via LHR)

### Ground Transport (`data/ground/{region}.json`)
- OSRM driving times (integrated — 1201 airports, 1.6M cells, 36% of reachable airports)
- Lazy-loaded by region

## Travel Time Calculation

```
Total = ground_to + overhead(90) + flights + connections(stops × 120) + arrival(30-60) + ground_from
```

- **Ground time**: Haversine distance / 40 km/h (OSRM when available)
- **Airport overhead**: 90 minutes (security, boarding)
- **Connection overhead**: 90 min layover + 30 min re-board per stop
- **Arrival overhead**: 30 min domestic, 60 min international
- **Flight time**: Estimated from great-circle distance (actual times TODO)

### Algorithm (Dijkstra — current)
1. `dijkstra_router.py` runs multi-source bounded-stops dijkstra from origin airports (once, 0.3s)
2. `precompute-isochrone.py` builds h3 res-2 spatial index of reachable airports
3. For each H3 cell: find nearby airports via spatial index, pick min(dijkstra_time + ground_from)
4. Output compact JSON per cell: `{t, o, a, s}` (time, origin airport, dest airport, stops)
5. `isochrone.html` loads JSON, derives breakdown client-side via `parseCellData()`

Coverage from Bristol: 338 direct + 2156 one-stop + 645 two-stop = 3139 airports

## Time Bands (Galton-style)

```javascript
const TIME_BANDS = [
  { maxHours: 2, color: '#22c55e', label: '< 2h' },      // Green
  { maxHours: 4, color: '#84cc16', label: '2-4h' },      // Lime
  { maxHours: 6, color: '#eab308', label: '4-6h' },      // Yellow
  { maxHours: 8, color: '#f97316', label: '6-8h' },      // Orange
  { maxHours: 10, color: '#ef4444', label: '8-10h' },    // Red
  { maxHours: 12, color: '#dc2626', label: '10-12h' },   // Dark red
  { maxHours: 14, color: '#991b1b', label: '12-14h' },   // Darker red
  { maxHours: Infinity, color: '#450a0a', label: '14h+' } // Very dark
];
```

## H3 Grid Generation

### Dynamic Resolution (Viewport-based)
Grid is now rendered only for the visible viewport, enabling finer resolution:
- **Resolution 2**: Globe view (zoom < 2), ~86k km² cells
- **Resolution 3**: Continental (zoom 2-3.5), ~12k km² cells
- **Resolution 4**: Regional (zoom 3.5-5), ~1.7k km² cells
- **Resolution 5**: Local (zoom 5-7), ~252 km² cells
- **Resolution 6**: Street level (zoom 7+), ~36 km² cells

Typical cell counts per viewport: 1,000-15,000 (vs 250k+ for full world)

### Sampling
Grid is generated by sampling lat/lng points and getting H3 cells:
```javascript
const step = resolution === 2 ? 1.5 : (resolution === 3 ? 0.7 : 0.2);
for (let lat = -55; lat <= 75; lat += step) {
  for (let lng = -180; lng <= 180; lng += step) {
    // Get H3 cell, calculate travel time, add to features
  }
}
```

**Known issue**: Step size affects coverage. Too large = gaps. Too small = slow.

### Antimeridian Handling
Cells that cross the 180° longitude line (antimeridian) have coordinates on both sides:
- Some near +180 (e.g., 170°, 175°)
- Some near -180 (e.g., -170°, -175°)

**Solution**: Normalize by shifting negative longitudes to positive:
```javascript
if (hasPositive && hasNegative) {
  coordinates = coordinates.map(([lng, lat]) => [
    lng < 0 ? lng + 360 : lng,
    lat
  ]);
}
```
This keeps polygons contiguous (e.g., 170°, 175°, 185°, 190°) instead of wrapping around the world.

## MapLibre Configuration

### Globe Projection (v5+ required)
```javascript
map.on('style.load', () => {
  map.setProjection({ type: 'globe' });
});
```

### Layer Order (bottom to top)
1. `hexgrid-fill` - Colored hex cells
2. `hexgrid-line` - Hex borders (hidden at low zoom)
3. `country-borders` - White country borders
4. `airports` - White dot markers
5. `airport-labels` - Airport codes (visible at zoom 4+)
6. `origin-pulse` - Green glow effect
7. `origin` - Green origin marker

### Hex Border Visibility (zoom-based)
```javascript
'line-width': ['interpolate', ['linear'], ['zoom'], 0, 0, 3, 0, 5, 0.3, 8, 0.5],
'line-opacity': ['interpolate', ['linear'], ['zoom'], 0, 0, 3, 0, 5, 0.1, 8, 0.15]
```

### Fill Opacity (time-based fade)
```javascript
'fill-opacity': ['interpolate', ['linear'], ['get', 'travelTimeMinutes'],
  0, 0.45,      // Near origin
  360, 0.4,     // 6 hours
  600, 0.3,     // 10 hours
  840, 0.2,     // 14 hours
  1200, 0.1     // 20+ hours (mostly ocean)
]
```

## Known Issues & Future Improvements

### Issues (Historical — mostly resolved)
1. ~~**Tooltip "Arrival + ground" too high**~~ - FIXED
2. ~~**No dynamic resolution**~~ - FIXED
3. ~~**Antimeridian gap/artifacts**~~ - FIXED
4. ~~**Incomplete flight data**~~ - FIXED: 58k routes from Amadeus + OpenFlights
5. ~~**Hub routing**~~ - FIXED: dijkstra with multi-stop connections
6. ~~**Caching / pre-compute**~~ - FIXED: pre-computed JSON, direct rendering

### Current Issues
1. **Display coarseness** - res 4 cells visible at medium zoom
2. **Flight times estimated** - distance-based, not actual schedules
3. **Bristol only** - precomputed data for one origin so far

### Future Improvements
1. **Higher-res rendering** - per-resolution file splitting, selective res 5
2. **Real flight times** - crawl amadeus flight offers API
3. **More origins** - run precompute per city
4. **Integrate ground transport** - OSRM crawl done, needs isochrone recompute
5. **Web Workers** - offload on-demand computation (if kept)

## Running Locally

```bash
python -m http.server 8765
# Open http://localhost:8765/isochrone.html
```

## File Structure

```
jetspan/
├── isochrone.html              # Main visualization
├── data/
│   ├── airports.json           # 4518 airports
│   ├── routes.json             # 58k routes
│   ├── isochrones/bristol.json # Pre-computed isochrone (8.7 MB)
│   └── ground/{region}.json     # OSRM ground times (complete, 8 regions)
├── scripts/
│   ├── dijkstra_router.py      # Core routing algorithm
│   ├── precompute-isochrone.py  # Generates isochrone JSON
│   └── ...                     # Data fetching/processing scripts
├── index.html                  # Warped maps (legacy)
├── panels.html                 # 9-panel comparison (legacy)
├── lhostis.html                # 3D shrivelled USA (legacy)
└── ISOCHRONE-DEV-NOTES.md      # This documentation
```

## Key Code Sections (isochrone.html)

- HTML/CSS structure
- `ORIGINS` config — origin cities with airport lists and ground times
- `loadJetSpanData()` — loads airports.json, routes.json, isochrone JSON
- `parseCellData()` — converts compact `{t,o,a,s}` format to full breakdown
- `generateHexGridDirect()` — renders pre-computed cells (res 1-4, instant)
- `generateHexGrid()` — on-demand grid iteration fallback (res 5-6)
- `showTooltip()` — routing breakdown display
- MapLibre initialization, layers, event handlers

## Dependencies (CDN)

```html
<script src="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl@5.0.0/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://unpkg.com/h3-js@4.1.0/dist/h3-js.umd.js"></script>
```

## Testing Checklist

- [x] Globe rotates smoothly
- [x] Hex colors match legend
- [x] Origin selector changes grid
- [x] Airports toggle works
- [x] Hex grid toggle works
- [x] Tooltip shows on hover
- [x] Country borders visible
- [x] No antimeridian gaps
- [x] No darker/lighter hemisphere artifacts
- [ ] No console errors
